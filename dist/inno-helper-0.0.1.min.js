var Loader=function(){var e=null,t=function(){$("body").append('<div id="inno-loader" style="display: none;"><div class="overlay"></div><div class="spinner"></div></div>'),e=$("#inno-loader")};return{show:function(){e||t(),e.show()},hide:function(){e&&e.hide()}}}(),PostMessenger=function(){this.messageStack={},window.addEventListener?window.addEventListener("message",this.messageHandler.bind(this)):window.attachEvent("onmessage",this.messageHandler.bind(this))};PostMessenger.prototype={messageHandler:function(e){var t={};try{t=JSON.parse(e.data)}catch(n){return!1}return t.requestId&&this.messageStack[t.requestId]&&this.messageStack[t.requestId]instanceof Function?this.messageStack[t.requestId](t.success,t.message):!1},getUniqId:function(){return Math.round(1e3*(Date.now()+window.performance.now()))},sendMessage:function(e,t){if(e instanceof Object){var n=this.getUniqId();e.requestId=n;try{e=JSON.stringify(e)}catch(s){return!1}return t instanceof Function&&(this.messageStack[n]=t),this.send(e)}return!1},send:function(e){if(window.parent&&window.self!==window.top)return window.parent.postMessage(e,"*"),!0;throw new Error("This page must be run in iframe.")}};var IframeHelper=function(){this.ready=!1,this.readyStack=[],this.pm=new PostMessenger,this.currentData=null,this.profileSchemaData=null,setTimeout(this.loadCurrentData.bind(this),0)};IframeHelper.prototype={onReady:function(e){this.addReadyListener(e)},addReadyListener:function(e){this.ready?e():this.readyStack.push(e)},dispatchReadyEvent:function(){this.ready=!0,this.readyStack.forEach(function(e){e instanceof Function&&e()})},request:function(e,t,n){var s={};2===arguments.length&&t instanceof Function&&(n=t,t=null),s.codename=e,s.value=t,this.pm.sendMessage(s,n)},loadCurrentData:function(){var e=this;this.request("gui.current.data",function(t,n){if(!t)throw new Error(n);e.currentData=n,e.dispatchReadyEvent()})},getCurrentUser:function(){return this.currentData.user},getCurrentGroup:function(){return this.currentData.group},getCurrentBucket:function(){return this.currentData.bucket},getCurrentApp:function(){return this.currentData.app},getCurrentSection:function(){return this.currentData.section},getSections:function(){return this.currentData.sections},getProperties:function(e){this.request("app.settings",e)},setProperties:function(e,t){this.request("app.settings;update",e,t)},setWidgetSettings:function(e,t){this.request("app.widget.settings;update",e,t)},getWidgetSettings:function(e){this.request("app.widget.settings",e)},removeProperties:function(e){this.request("app.settings;delete",e)},getProperty:function(e,t){this.request("app.property",{property:e},t)},setProperty:function(e,t,n){e?this.request("app.property;update",{property:e,value:t},n):n(!1,"Property is undefined")},removeProperty:function(e,t){e?this.request("app.property;delete",e,t):t(!1,"Property is undefined")},getEventListeners:function(e){this.request("app.event.listeners",e)},removeEventListener:function(e,t){this.request("app.event.listener;delete",t)},addEventListener:function(e,t){this.request("app.event.listener;create",e,t)},getProfileSchema:function(e){var t=this;this.profileSchemaData?e(!0,this.profileSchemaData):this.request("app.profile.schema",function(n,s){t.profileSchemaData=s,e(n,s)})},getProfileSchemaElementsByRegexp:function(e,t){this.getProfileSchema(function(n,s){var i,r,o,a=[];if(s&&s.entries&&s.entries instanceof Object){i=s.entries;for(r in i)i[r].accepted&&(o=r.match(e),o&&a.push(o.slice(1).join("/")))}t instanceof Function&&(a.sort(),t(a))})},getProfileSchemaAttributes:function(e){var t=/^attributes\.([^.]+)\.([^.]+)\.data\.([^.]+)$/i;this.getProfileSchemaElementsByRegexp(t,e)},getProfileSchemaSessionDatas:function(e,t,n){var s="^sessions.("+e+").("+t+").data.([^.]+)$",i=new RegExp(s);this.getProfileSchemaElementsByRegexp(i,function(e){n instanceof Function&&(e=e.map(function(e){var t=e.split("/");return t[t.length-1]}),n(e))})},getProfileSchemaEventDefinitions:function(e){var t=/^sessions\.([^.]+)\.([^.]+)\.events\.([^.]+)$/i;this.getProfileSchemaElementsByRegexp(t,e)},getProfileSchemaEventDefinitionDatas:function(e,t,n,s){var i="^sessions.("+e+").("+t+").events.("+n+").data.([^.]+)$",r=new RegExp(i);this.getProfileSchemaElementsByRegexp(r,function(e){s instanceof Function&&(e=e.map(function(e){var t=e.split("/");return t[t.length-1]}),s(e))})},getRules:function(e){this.request("app.rules",e)},setRules:function(e,t){this.request("app.rules;set",e,t)},getSectionsFullList:function(e){this.request("gui.sections.full.list",e)},addLogMessage:function(e,t){this.request("app.logs.message;create",e,t)},addScreenMessage:function(e,t){this.request("screen.message",{message:e,type:t})},sendIsReady:function(){this.request("iframe.status;update")}},function(){var e=function(e){var t=document.referrer+(window.elyProxyUrlForCustomApps||"app_custom_proxy?url=");return e&&/^https?:/.test(e)?window!==window.parent&&(e=e&&/^http:/.test(e)?t+encodeURIComponent(e):e):e=window.location.origin+("/"===e.charAt(0)?e:"/"+e),e},t=function(){return XMLHttpRequest.prototype._open=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(t,n){return n=e(n),this._open.apply(this,arguments)},XMLHttpRequest},n=function(){return window.fetch?(window._fetch=window.fetch,void(window.fetch=function(t){if(window.Request&&t instanceof Request){var n=e(t.url);n!==t.url&&(t=new Request(n,{method:t.method,headers:t.headers,mode:t.mode}))}else t.toString&&t.toString()===t&&(t=e(t));return window._fetch.apply(null,arguments)})):!1};window.IS_DEVELOPMENT&&"https:"!==window.location.protocol&&(t(),n())}();